* Meta-data :noexport:
  # http://orgmode.org/worg/exporters/beamer/tutorial.html
  #+TITLE: What is the @@latex:\\@@
  #+TITLE: Expectation Maximization @@latex:\\@@
  #+TITLE: (EM) Algorithm? @@latex:\\@@
  #+AUTHOR: Kazuki Yoshida @@latex:\\@@
  #+AUTHOR: @@latex:\\@@
  #+AUTHOR: Division of Rheumatology, Immunology and Allergy @@latex:\\@@
  #+AUTHOR: Brigham and Women's Hospital & Harvard Medical School @@latex:\\@@
  #+AUTHOR: \faTwitter @kaz_yos \faGithub kaz-yos \faEnvelope kazukiyoshida@mail.harvard.edu
  #+DATE: 2019-05-20@@latex:\\@@
  #+DATE: Mini-Statistics Camp Series @@latex:\\@@
  #+DATE: BWH Bioinformatics Club @@latex:\\@@
  #+DESCRIPTION:
  #+KEYWORDS:
  #+OPTIONS: toc:nil
  #+OPTIONS: H:2
  #+OPTIONS: ^:{}
  #+STARTUP: beamer
  #+COLUMNS: %40ITEM %10BEAMER_env(Env) %9BEAMER_envargs(Env Args) %4BEAMER_col(Col) %10BEAMER_extra(Extra)
  #+LATEX_CLASS: beamer
  #+LATEX_CLASS_OPTIONS: [dvipdfmx,bigger,aspectratio=169]
  #+LATEX_HEADER: %% No navigation bar
  #+LATEX_HEADER: \setbeamertemplate{navigation symbols}{}
  #+LATEX_HEADER: %% Page number with current/total format
  #+LATEX_HEADER: \setbeamerfont{page number in head/foot}{size=\scriptsize}
  #+LATEX_HEADER: \setbeamertemplate{footline}[frame number]
  #+LATEX_HEADER: \setbeamertemplate{frametitle}[default][center]
  #+LATEX_HEADER: \setbeamersize{text margin left=5mm,text margin right=5mm}
  #+LATEX_HEADER: %% With item labels
  #+LATEX_HEADER: \setbeamertemplate{bibliography item}{\insertbiblabel}
  #+LATEX_HEADER: %% Without item labels
  #+LATEX_HEADER: %% \setbeamertemplate{bibliography item}{}
  #+LATEX_HEADER:
  #+LATEX_HEADER: %% Math
  #+LATEX_HEADER: \usepackage{amsmath}
  #+LATEX_HEADER: \usepackage{amssymb}
  #+LATEX_HEADER: \usepackage{wasysym}
  #+LATEX_HEADER: %% Allow new page within align
  #+LATEX_HEADER: \allowdisplaybreaks
  #+LATEX_HEADER: \usepackage{cancel}
  #+LATEX_HEADER: %% Code
  #+LATEX_HEADER: \usepackage{listings}
  #+LATEX_HEADER: \usepackage{courier}
  #+LATEX_HEADER: \lstset{basicstyle=\footnotesize\ttfamily, breaklines=true, frame=single}
  #+LATEX_HEADER: \usepackage[cache=false]{minted}
  #+LATEX_HEADER: \usemintedstyle{vs}
  #+LATEX_HEADER: %% Graphics
  #+LATEX_HEADER: \usepackage{graphicx}
  #+LATEX_HEADER: \usepackage{grffile}
  #+LATEX_HEADER: %% DAG
  #+LATEX_HEADER: \usepackage{tikz}
  #+LATEX_HEADER: \usetikzlibrary{positioning,shapes.geometric}
  #+LATEX_HEADER: %% Allow URL embedding
  #+LATEX_HEADER: \usepackage{url}
  #+LATEX_HEADER: %% Do not count backup slides.
  #+LATEX_HEADER: %% https://tex.stackexchange.com/questions/70448/dont-count-backup-slides
  #+LATEX_HEADER: \usepackage{appendixnumberbeamer}
  #+LATEX_HEADER: %% https://www.sharelatex.com/learn/Hyperlinks
  #+LATEX_HEADER: \usepackage{hyperref}
  #+LATEX_HEADER: \hypersetup{
  #+LATEX_HEADER:     colorlinks = true,
  #+LATEX_HEADER:     linkcolor= blue
  #+LATEX_HEADER: }
  #+LATEX_HEADER: \usepackage{fontawesome}
  #+LATEX_HEADER: %% Include convenient commands.
  #+LATEX_HEADER: \input{\string~/.emacs.d/misc/GrandMacros}

* Introduction
** Article Covered
- Do and Batzoglou. "What is the expectation maximization algorith?" Nat. Biotechnol. 2008;26:897. cite:doWhatExpectationMaximization2008
#+ATTR_LATEX: :width 0.8\textwidth :options page=1,keepaspectratio :center t
[[./source/em_algo.png]]
\footnotesize
Presented as a part of the Mini Statistics Camp 2009 hosted by the [[http://bioinformatics.bwh.harvard.edu][BWH/HMS Bioinformatics Club]]

** Introduction
- Probabilistic models, such as hidden Markov models and Bayesian networks, are commonly used to model biological data.

- The Expectation-Maximization (EM) algorithm enables parameter estimation in probabilistic models with incomplete data.

** Incomplete data
- Incomplete data encompass:
  - Missing data
  - Latent class (unobserved class assignment)

* Experiment Setup
** A Coin-Flipping Experiment
- Two coins $A$ (0) and $B$ (1) with unknown head probabilities $(\theta_{0},\theta_{1})$
- Repeat 5 times
  1. Randomly pick either coin
  2. Toss 10 times and record the number of heads
#+ATTR_LATEX: :height 0.5\textheight :options page=1,keepaspectratio :center t
[[./source/experiment_data.png]]

** A Coin-Flipping Experiment (More Formal)
- Two coins $A$ (0) and $B$ (1) with unknown head probabilities $(\theta_{0},\theta_{1})$
- For $i = 1, \dots, 5$
  1. Draw $Z_{i} \sim \text{Bernoulli}(p = 0.5), Z_{i} \in \left\{ 0,1 \right\}$
  2. Draw $X_{i} | Z_{i} \sim \text{Binomial}(n = 10, p = \theta_{Z_{i}}), X_{i} \in \left\{ 0, \dots, 10 \right\}$
| Index |    Coin |   Heads |
|   $i$ | $Z_{i}$ | $X_{i}$ |
|-------+---------+---------|
|     1 |       1 |       5 |
|     2 |       0 |       9 |
|     3 |       0 |       8 |
|     4 |       1 |       4 |
|     5 |       0 |       7 |
- Note that you only need the number of heads ([[https://www.statisticshowto.datasciencecentral.com/sufficient-statistic/][sufficient statistic]]), not the entire sequence.

* Complete-Data Case
** Complete-Data Maximum Likelihood
- If we observe both the coin identity $Z_{i}$ and heads $X_{i}$, the MLE is the total heads / total tosses for each coin.
- Here we introduce a very redundant expanded table for later reuse.
\footnotesize
| Index  | Coin    |                    Prob. Coin A |                Prob. Coin B |   Heads | Heads for Coin A                       | Heads for Coin B                   |
| $i$    | $Z_{i}$ | $E[(1-Z_{i})\vert Z_{i},X_{i}]$ | $E[Z_{i}\vert Z_{i},X_{i}]$ | $X_{i}$ | $E[(1-Z_{i}) X_{i} \vert Z_{i},X_{i}]$ | $E[Z_{i} X_{i} \vert Z_{i},X_{i}]$ |
|--------+---------+---------------------------------+-----------------------------+---------+----------------------------------------+------------------------------------|
| /      | <>      |                               < |                           > |         | <                                      | >                                  |
| 1      | 1 (B)   |                               0 |                           1 |       5 | 0 \times 5                             | 1 \times 5                         |
| 2      | 0 (A)   |                               1 |                           0 |       9 | 1 \times 9                             | 0 \times 9                         |
| 3      | 0 (A)   |                               1 |                           0 |       8 | 1 \times 8                             | 0 \times 8                         |
| 4      | 1 (B)   |                               0 |                           1 |       4 | 0 \times 4                             | 1 \times 4                         |
| 5      | 0 (A)   |                               1 |                           0 |       7 | 1 \times 7                             | 0 \times 7                         |
|--------+---------+---------------------------------+-----------------------------+---------+----------------------------------------+------------------------------------|
| Heads  |         |                                 |                             |         | 24                                     | 9                                  |
| Tosses |         |                10 \times 3 = 30 |            10 \times 2 = 20 |         | 30                                     | 20                                 |
| MLE    |         |                                 |                             |         | $\thetahat_{0} = 0.80$                 | $\thetahat_{1} = 0.45$             |


* Experiment Setup (Incomplete Data)
** A Contrived Coin-Flipping Experiment
- Two identical-looking coins with unknown head probabilities
- Repeat 5 times
  1. You are randomly given either coin, but you do not know which.
  2. You toss 10 times, record the number of heads, and return the coin.
| Index | Coin    |   Heads |
|   $i$ | $Z_{i}$ | $X_{i}$ |
|-------+---------+---------|
|     1 | ?       |       5 |
|     2 | ?       |       9 |
|     3 | ?       |       8 |
|     4 | ?       |       4 |
|     5 | ?       |       7 |
- Can we still estimate the two unknown head probabilities?

** A Contrived Coin-Flipping Experiment (More Formal)
- Two identical-looking coins with unknown head probabilities $(\theta_{0},\theta_{1})$ (index arbitrary)
- For $i = 1, \dots, 5$
  1. Draw /latent/ $Z_{i} \sim \text{Bernoulli}(p = 0.5), Z_{i} \in \left\{ 0,1 \right\}$
  2. Draw $X_{i} | Z_{i} \sim \text{Binomial}(n = 10, p = \theta_{Z_{i}}), X_{i} \in \left\{ 0, \dots, 10 \right\}$
| Index | Coin    |   Heads |
|   $i$ | $Z_{i}$ | $X_{i}$ |
|-------+---------+---------|
|     1 | ?       |       5 |
|     2 | ?       |       9 |
|     3 | ?       |       8 |
|     4 | ?       |       4 |
|     5 | ?       |       7 |


* EM Algorithm
** EM Algorithm to the Rescue
- The Expectation-Maximization (EM) Algorithm cite:dempsterMaximumLikelihoodIncomplete1977
- After random initialization of parameters, two steps alternates until convergence.
- Steps repeated
  1. E-Step:
     - Estimate probabilities of latent states given current parameters
     - Obtain expected sufficient statistics
  2. M-Step:
     - Obtain MLE of parameters given expected sufficient statistics

** Parameter Initialization
- Randomly initialize the parameters
  - $\thetahat_{0}^{(0)} := 0.6$
  - $\thetahat_{1}^{(0)} := 0.5$

** E-Step (1)
   :PROPERTIES:
   :BEAMER_opt: allowframebreaks,label=,t
   :END:
- Current parameters: $\thetahat_{0}^{(0)} = 0.6, \thetahat_{1}^{(0)} = 0.5$
\footnotesize
| Index  | Coin    | Prob. Coin A              | Prob. Coin B          |   Heads | Heads for Coin A                 | Heads for Coin B             |
| $i$    | $Z_{i}$ | $E[(1-Z_{i})\vert X_{i}]$ | $E[Z_{i}\vert X_{i}]$ | $X_{i}$ | $E[(1-Z_{i}) X_{i} \vert X_{i}]$ | $E[Z_{i} X_{i} \vert X_{i}]$ |
|--------+---------+---------------------------+-----------------------+---------+----------------------------------+------------------------------|
| /      | <>      | <                         | >                     |         | <                                | >                            |
| 1      | ?       | ?                         | ?                     |       5 | ? \times 5                       | ? \times 5                   |
| 2      | ?       | ?                         | ?                     |       9 | ? \times 9                       | ? \times 9                   |
| 3      | ?       | ?                         | ?                     |       8 | ? \times 8                       | ? \times 8                   |
| 4      | ?       | ?                         | ?                     |       4 | ? \times 4                       | ? \times 4                   |
| 5      | ?       | ?                         | ?                     |       7 | ? \times 7                       | ? \times 7                   |
|--------+---------+---------------------------+-----------------------+---------+----------------------------------+------------------------------|
| Heads  |         |                           |                       |         | ?                                | ?                            |
| Tosses |         | 10 \times ? = 30          | 10 \times ? = 20      |         | ?                                | ?                            |
| MLE    |         |                           |                       |         | $\thetahat_{0} = ?$              | $\thetahat_{1} = ?$          |
\normalsize
- First we need coin probabilities for each $i$ given the current parameter values $\bthetahat^{(0)}$.

\newpage
- Since they are complements, we only need the probability of coin B given the number of heads observed and current parameter values.
\footnotesize
\begin{align*}
  E_{\bthetahat^{(0)}}[Z_{i} | X_{i} = x_{i}] &= P_{\bthetahat^{(0)}}[Z_{i} = 1 | X_{i} = x_{i}]\\
  &~~~\text{Bayes rule}\\
  &= \frac{P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = 1] P_{\bthetahat^{(0)}}[Z_{i} = 1]}
          {\sum\limits^{1}_{z=0} P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = z] P_{\bthetahat^{(0)}}[Z_{i} = z]}\\
  &~~~\text{Coin choice probability = 0.5}\\
  &= \frac{P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = 1] (0.5)}
          {\sum\limits^{1}_{z=0} P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = z] (0.5)}\\
  &= \frac{P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = 1]}
          {P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = 0] + P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = 1]}\\
\end{align*}
\normalsize

\newpage
- $P_{\bthetahat^{(0)}}[X_{i} = x_{i} | Z_{i} = z]$ is the probability mass (=dbinom=) of observed $X_{i}$ assuming coin identity $z$ and current parameter values.

\footnotesize
#+BEGIN_SRC R :session *R-org* :results output :exports both
suppressMessages(library(tidyverse))
options(crayon.enabled = FALSE)
rel_dbinom <- function(X, theta0, theta1) {
  p_X_Z0 <- dbinom(x = X, size = 10, prob = theta0)
  p_X_Z1 <- dbinom(x = X, size = 10, prob = theta1)
  tibble(p_Z0_X = p_X_Z0 / (p_X_Z0 + p_X_Z1),
         p_Z1_X = p_X_Z1 / (p_X_Z0 + p_X_Z1))
}
bind_rows(rel_dbinom(5, 0.6, 0.5),
          rel_dbinom(9, 0.6, 0.5),
          rel_dbinom(8, 0.6, 0.5),
          rel_dbinom(4, 0.6, 0.5),
          rel_dbinom(7, 0.6, 0.5))
#+END_SRC
\normalsize


* Appendix
\appendix
** Bibliography
   :PROPERTIES:
   :BEAMER_opt: allowframebreaks,label=,t
   :END:
\tiny
# To remove "References" section header
\renewcommand{\section}[2]{}
# Following lines must be left-aligned without preceding spaces.
bibliographystyle:apalike
bibliography:~/.emacs.d/misc/zotero.bib
